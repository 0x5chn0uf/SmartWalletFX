# Product Requirements Document

**Project:** Test-Suite Restructure & Simplification  
**Author:** _generated by AI_  
**Last updated:** <!-- date will be filled automatically by version control -->  
**Target release:** v0.2.0 (est.)

---

## 1. Executive Summary

Our current backend test-suite contains ~850 test files, >250 fixtures, and several overlapping directory conventions. While coverage is high, day-to-day developer UX is poor: slow discovery, unclear ownership, and high onboarding cost.  
This PRD proposes a domain-driven re-organisation, dramatic fixture simplification, and clearer layering that mirrors the project’s hexagonal architecture. The outcome will be a faster, more maintainable, and more readable test-suite that scales as the team and codebase grow.

---

## 2. Goals & Success Criteria

| ID  | Goal                                            | Metric / Acceptance Criteria                                                  |
| --- | ----------------------------------------------- | ----------------------------------------------------------------------------- |
| G-1 | Make tests easy to locate by feature/domain     | 100 % of new tests land under `backend/tests/domains/*` or `infrastructure/*` |
| G-2 | Reduce fixture complexity                       | Global fixture count ↓ ≥ 60 % (≈ 250 → < 100) without lowering coverage       |
| G-3 | Establish clear unit / integration / e2e layers | Every domain has `unit/`, `integration/`, (_optional_) `e2e/` sub-folders     |
| G-4 | Preserve or improve coverage                    | Line coverage ≥ current baseline (≈ 92 %)                                     |
| G-5 | Faster local feedback                           | Median `pytest -q` runtime ↓ ≥ 25 %                                           |

---

## 3. Problem Statement

1. **Cognitive Load** – Multiple naming conventions (`unit/api/*`, `integration/api/*`, `property/*`) make it hard to know where to add or locate tests.
2. **Fixture Sprawl** – A single `conftest.py` imports >250 fixtures; developers waste time discovering the right fixture or debugging fixture chains.
3. **Architecture Mismatch** – Tests are organised mostly by layer, not by business domain, obscuring domain boundaries central to our hexagonal design.
4. **CI Drag** – Test discovery & collection are slower than needed; unnecessary fixtures are initialised even when unused.

---

## 4. Proposed Solution (Scope)

### 4.1 Directory Layout

```text
backend/tests/
├── domains/
│   ├── auth/
│   │   ├── unit/
│   │   ├── integration/
│   │   └── e2e/ (opt)
│   ├── wallets/
│   ├── defi/
│   └── admin/
├── infrastructure/
│   ├── database/
│   ├── external_apis/
│   ├── security/
│   └── storage/
├── shared/
│   ├── fixtures/
│   ├── strategies/
│   └── utils/
└── performance/             # Dedicated perf / load tests
```

### 4.2 Fixture Strategy

1. **Core fixtures** live in `shared/fixtures/` (≤ 20 items): database session, FastAPI app, HTTP client, sample user/wallet, etc.
2. **Domain fixtures** extend or override core fixtures inside their `domains/<name>/conftest.py`.
3. **No Wildcard Import**: Stop re-exporting every fixture via top-level `conftest.py`; import explicitly in tests.
4. **Auto-use trimmed**: Only truly global behaviours (`Hypothesis` profile, custom markers) stay auto-use.

### 4.3 Layer Separation

- **Unit tests** – isolated verification of a single class/function (mock collaborators).
- **Integration tests** – verify collaboration across layers within the same domain (e.g., endpoint → usecase → repository, hitting SQLite).
- **E2E tests** (optional) – full workflow across multiple domains (e.g., registration → email-verification → login → create wallet).

### 4.4 Naming Conventions

- Test file: `test_<subject>.py` (singular)
- Test class optional; if used: `Test<Subject>`
- Use docstring to declare intent (`"""Test WalletUsecase business rules."""`)

### 4.5 CI/CD Updates

- Update GitHub Actions path remains `pytest backend/tests`.
- Default job runs `pytest -m "not performance"`; nightly job runs `performance` suite.
- Enforce coverage gate against new baseline.

### 4.6 Migration Script

Provide an `invoke migrate_tests` helper that:

1. Creates new directories.
2. Moves existing files via mapping.
3. Inserts deprecation notices in old folders for one release cycle.

---

## 5. Out-of-Scope

- Front-end and Cypress tests – unchanged.
- Refactoring production code for testability (tracked separately).
- Switching test runner (we stay on `pytest`).

---

## 6. User Stories / Requirements

| Ref  | As a …          | I want …                                      | So that …                                                 |
| ---- | --------------- | --------------------------------------------- | --------------------------------------------------------- |
| US-1 | Developer       | to quickly find the auth tests                | I can add / modify tests without searching the whole repo |
| US-2 | New team member | a small set of easily understandable fixtures | onboarding is fast                                        |
| US-3 | QA engineer     | clear separation of unit / integration / e2e  | we can choose which subset to run                         |
| US-4 | CI maintainer   | shorter test collection & runtime             | pipelines finish faster                                   |

---

## 7. Milestones & Timeline

| Week | Deliverable                                                            |
| ---- | ---------------------------------------------------------------------- |
| 1    | Directory skeleton & core fixtures (`shared/fixtures/core.py`)         |
| 2    | Migrate **Auth** domain tests; deprecate old folders                   |
| 3    | Migrate **Wallets** + **Admin** domain tests                           |
| 4    | Migrate remaining domains; remove unused fixtures                      |
| 5    | Introduce cross-domain e2e workflows & performance harness             |
| 6    | Cleanup, update docs (`docs/testing/structure.md`), delete legacy dirs |

---

## 8. Metrics & KPIs

- **Fixture count** `< 100`
- **Median local test run** `pytest -q` ≤ 75 s (was ~110 s)
- **Coverage** ≥ 92 %
- **PR review time for test-only changes** ↓ 25 %

---

## 9. Risks & Mitigations

| Risk                                  | Impact | Likelihood | Mitigation                                                            |
| ------------------------------------- | ------ | ---------- | --------------------------------------------------------------------- |
| Large merge conflicts during moves    | Medium | Medium     | Domain-by-domain migration; short-lived branch; freeze test additions |
| Dropping coverage accidentally        | High   | Low        | Coverage gate in CI; before/after diff in PR                          |
| Developer confusion during transition | Medium | Medium     | Migration guide, path alias stubs, internal workshop                  |
| Fixture dependencies break            | Medium | Medium     | Incremental migration; keep legacy fixtures until stable              |

---

## 10. Stakeholders

| Role          | Team         | Responsibility             |
| ------------- | ------------ | -------------------------- |
| Product Owner | Backend Lead | Approve scope & priorities |
| QA Lead       | QA / SDET    | Define coverage targets    |
| DevX          | Tooling      | Update CI pipelines        |
| Engineering   | Backend devs | Implement migration        |

---

## 11. Appendix

### A. Sample `shared/fixtures/core.py`

```python
import pytest
from httpx import AsyncClient
from sqlalchemy.ext.asyncio import AsyncSession

from app.main import app as fastapi_app
from app.core.database import get_db as _get_db


@pytest.fixture(scope="session")
def anyio_backend():
    return "asyncio"


@pytest.fixture
async def db_session(async_engine) -> AsyncSession:
    async with async_engine.begin() as conn:
        yield AsyncSession(bind=conn)


@pytest.fixture
async def client(db_session):
    async def _override_get_db():
        yield db_session
    fastapi_app.dependency_overrides[_get_db] = _override_get_db
    async with AsyncClient(app=fastapi_app, base_url="http://test") as c:
        yield c
```

### B. Example Test File

```python
# backend/tests/domains/auth/unit/test_auth_service.py
"""Unit tests for AuthService business logic."""

def test_register_duplicate_email_fails(auth_service, db_session):
    user1 = ...
    with pytest.raises(DuplicateError):
        ...
```

---

_End of PRD_
