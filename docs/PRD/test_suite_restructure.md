# Product Requirements Document

**Project:** Test-Suite Comprehensive Restructure & DI Pattern Migration  
**Author:** _generated by AI_  
**Last updated:** 2025-07-17  
**Target release:** v0.2.0 (Phase 6 completion + architectural modernization)

---

## 1. Executive Summary

Our backend test-suite requires comprehensive restructuring to align with modern architecture patterns while completing Phase 6 of the DI refactoring. While some domain organization exists, the test suite needs complete architectural overhaul: proper domain-driven organization, elimination of fixture sprawl, clear unit/integration/e2e separation, and DI pattern standardization.

This PRD addresses both immediate Phase 6 completion (DI pattern migration across ~300 test files) and long-term architectural goals (comprehensive test suite restructure following hexagonal architecture principles). The outcome will be a modern, maintainable, and scalable test-suite that serves as a foundation for future development.

---

## 2. Goals & Success Criteria

| ID  | Goal                                            | Metric / Acceptance Criteria                                                  |
| --- | ----------------------------------------------- | ----------------------------------------------------------------------------- |
| G-1 | Complete architectural domain reorganization    | 100% of tests organized under `domains/` and `infrastructure/` with clear separation |
| G-2 | Establish clear unit/integration/e2e layers     | Every domain has `unit/`, `integration/`, (optional) `e2e/` sub-folders     |
| G-3 | Complete DI pattern migration                   | 100% of tests use DI fixtures instead of legacy patterns (`AuthService(db_session)`) |
| G-4 | Optimize fixture architecture                   | Streamlined fixture hierarchy with domain-specific extensions                |
| G-5 | Standardize test user fixtures                  | All tests use `test_user`, `test_user_with_wallet` instead of custom creation |
| G-6 | Improve test performance                        | Median `pytest -q` runtime improvement through better organization           |
| G-7 | Preserve or improve coverage                    | Line coverage ≥ current baseline (~47%) with architectural improvements      |

---

## 3. Problem Statement

1. **Architectural Fragmentation** – Tests scattered across multiple directory conventions (`unit/api/*`, `integration/api/*`, `property/*`, `domain/*`) without clear domain boundaries or consistent layering.
2. **Legacy Pattern Debt** – ~300 test files still use old patterns like `AuthService(db_session)` instead of DI fixtures, creating inconsistency and maintenance burden.
3. **Fixture Complexity** – While reduced to 12 files, fixture organization needs domain-specific optimization and clearer inheritance patterns.
4. **Layer Confusion** – No clear separation between unit/integration/e2e tests, making it hard to run targeted test suites or understand test scope.
5. **Mixed Test Standards** – Tests use inconsistent user creation patterns instead of standardized fixtures, reducing maintainability.
6. **Developer Experience** – Difficult test discovery, unclear ownership, and high cognitive load for new team members.

---

## 4. Proposed Solution (Scope)

### 4.1 Target Architecture

```text
backend/tests/
├── domains/
│   ├── auth/
│   │   ├── unit/           # AuthService, JWT, password validation
│   │   ├── integration/    # Auth endpoints, OAuth flows
│   │   └── e2e/           # Complete registration → login flows
│   ├── wallets/
│   │   ├── unit/           # WalletUsecase, repository logic
│   │   ├── integration/    # Wallet API endpoints, blockchain calls
│   │   └── e2e/           # Wallet creation → portfolio tracking
│   ├── admin/
│   │   ├── unit/           # Admin business logic
│   │   ├── integration/    # Admin API endpoints
│   │   └── e2e/           # Admin workflows
│   └── defi/
│       ├── unit/           # DeFi calculations, token pricing
│       ├── integration/    # External API integration
│       └── e2e/           # Portfolio tracking workflows
├── infrastructure/
│   ├── database/          # Migration tests, connection handling
│   ├── security/          # Security middleware, rate limiting
│   ├── monitoring/        # Metrics, logging, performance
│   └── external_apis/     # Third-party service integration
├── shared/
│   ├── fixtures/          # Core fixtures (≤ 20 items)
│   │   ├── core.py       # Database, FastAPI app, HTTP client
│   │   ├── users.py      # Standard user fixtures
│   │   └── domain_fixtures/ # Domain-specific fixture extensions
│   ├── strategies/        # Hypothesis strategies
│   └── utils/            # Test utilities and helpers
└── performance/           # Load tests, benchmarks
```

### 4.2 Comprehensive Migration Strategy

**Phase A: Architectural Restructure**
1. **Directory Reorganization**: Move all tests to domain-based structure
2. **Layer Separation**: Organize tests by unit/integration/e2e within each domain
3. **Fixture Optimization**: Create domain-specific fixture hierarchies

**Phase B: DI Pattern Migration**
1. **Legacy Pattern Elimination**: Replace `AuthService(db_session)` with DI fixtures
2. **Repository Tests**: Use `repository_with_di` fixtures
3. **Usecase Tests**: Use `usecase_with_di` fixtures with proper mocking
4. **Standardized Users**: Replace custom user creation with standard fixtures

**Phase C: Performance & Quality**
1. **Test Performance**: Optimize test execution through better organization
2. **Coverage Validation**: Ensure no regression during migration
3. **Documentation**: Update test guidelines and patterns

### 4.3 Layer Separation

- **Unit tests** – isolated verification of a single class/function (mock collaborators).
- **Integration tests** – verify collaboration across layers within the same domain (e.g., endpoint → usecase → repository, hitting SQLite).
- **E2E tests** (optional) – full workflow across multiple domains (e.g., registration → email-verification → login → create wallet).

### 4.4 Naming Conventions

- Test file: `test_<subject>.py` (singular)
- Test class optional; if used: `Test<Subject>`
- Use docstring to declare intent (`"""Test WalletUsecase business rules."""`)

### 4.5 CI/CD Updates

- Update GitHub Actions path remains `pytest backend/tests`.
- Default job runs `pytest -m "not performance"`; nightly job runs `performance` suite.
- Enforce coverage gate against new baseline.

### 4.6 Migration Script

Provide an `invoke migrate_tests` helper that:

1. Creates new directories.
2. Moves existing files via mapping.
3. Inserts deprecation notices in old folders for one release cycle.

---

## 5. Out-of-Scope

- Front-end and Cypress tests – unchanged.
- Refactoring production code for testability (tracked separately).
- Switching test runner (we stay on `pytest`).

---

## 6. User Stories / Requirements

| Ref  | As a …          | I want …                                      | So that …                                                 |
| ---- | --------------- | --------------------------------------------- | --------------------------------------------------------- |
| US-1 | Developer       | to quickly find the auth tests                | I can add / modify tests without searching the whole repo |
| US-2 | New team member | a small set of easily understandable fixtures | onboarding is fast                                        |
| US-3 | QA engineer     | clear separation of unit / integration / e2e  | we can choose which subset to run                         |
| US-4 | CI maintainer   | shorter test collection & runtime             | pipelines finish faster                                   |

---

## 7. Milestones & Timeline

| Week | Deliverable                                                            |
| ---- | ---------------------------------------------------------------------- |
| 1    | **Phase A**: Complete directory restructure & domain organization     |
| 2    | **Phase A**: Establish unit/integration/e2e layers & fixture optimization |
| 3    | **Phase B**: Migrate Auth domain to DI pattern (~50 test files)       |
| 4    | **Phase B**: Migrate Repository & Usecase tests (~100 files)          |
| 5    | **Phase B**: Migrate Integration tests & standardize user fixtures (~150 files) |
| 6    | **Phase C**: Performance optimization, documentation, cleanup          |

---

## 8. Metrics & KPIs

- **Domain Organization** 100% of tests under `domains/` or `infrastructure/`
- **Layer Separation** Every domain has `unit/`, `integration/`, (optional) `e2e/`
- **DI Pattern Adoption** 100% (0 legacy patterns remaining)
- **Test User Standardization** 100% (all tests use standard fixtures)
- **Fixture Optimization** Streamlined hierarchy with domain-specific extensions
- **Test Performance** Improved test discovery and execution times
- **Coverage** ≥ 47% (maintain current baseline through migration)

---

## 9. Risks & Mitigations

| Risk                                  | Impact | Likelihood | Mitigation                                                            |
| ------------------------------------- | ------ | ---------- | --------------------------------------------------------------------- |
| Large-scale file moves create merge conflicts | High   | Medium     | Phase A migration in short-lived branches; coordinate with team      |
| Breaking existing tests during migration | High   | Medium     | Domain-by-domain migration; validate tests after each move           |
| DI fixture pattern inconsistency      | Medium | Low        | Follow established patterns in `test_*_di.py` examples               |
| Test discovery performance degradation | Medium | Medium     | Monitor test collection times; optimize fixture loading              |
| Coverage regression during restructure | Medium | Low        | Coverage gate enforcement; before/after validation                   |
| Developer confusion during transition | Medium | Medium     | Migration guide, internal workshops, clear documentation             |

---

## 10. Stakeholders

| Role          | Team         | Responsibility             |
| ------------- | ------------ | -------------------------- |
| Product Owner | Backend Lead | Approve scope & priorities |
| QA Lead       | QA / SDET    | Define coverage targets    |
| DevX          | Tooling      | Update CI pipelines        |
| Engineering   | Backend devs | Implement migration        |

---

## 11. Appendix

### A. DI Pattern Examples (Already Established)

#### Repository Test Pattern:
```python
@pytest.fixture
def user_repository(mock_database, mock_audit):
    return UserRepository(mock_database, mock_audit)

@pytest.mark.asyncio
async def test_get_by_id(user_repository_with_di, mock_database):
    # Follows established pattern in test_user_repository_di.py
    setup_mock_session(user_repository_with_di, mock_session)
    result = await user_repository_with_di.get_by_id(user_id)
    assert result.id == user_id
```

#### Usecase Test Pattern:
```python
@pytest.fixture
def wallet_usecase(mock_wallet_repo, mock_user_repo, mock_config, mock_audit):
    return WalletUsecase(mock_wallet_repo, mock_user_repo, mock_config, mock_audit)

@pytest.mark.asyncio
async def test_create_wallet(wallet_usecase_with_di, mock_wallet_repo):
    # Follows established pattern in test_wallet_usecase_di.py
    mock_wallet_repo.create.return_value = expected_wallet
    result = await wallet_usecase_with_di.create_wallet(wallet_data)
    assert result.address == expected_wallet.address
```

### B. Migration Checklist

**For each test file:**
- [ ] Replace `AuthService(db_session)` with `create_test_auth_service(db_session)`
- [ ] Replace direct repository instantiation with `*_repository_with_di` fixtures
- [ ] Replace direct usecase instantiation with `*_usecase_with_di` fixtures  
- [ ] Replace custom user creation with `test_user` fixtures
- [ ] Verify all tests pass after migration

---

_End of PRD_
